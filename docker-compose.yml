version: '3.8'

services:
  # ----------------------------
  # Database (MongoDB)
  # ----------------------------
  mongodb:
    image: mongo:latest
    container_name: hms_mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    # For production, enable authentication:
    # environment:
    #   - MONGO_INITDB_ROOT_USERNAME=admin
    #   - MONGO_INITDB_ROOT_PASSWORD=your_secure_password
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - hms_network

  # ----------------------------
  # Backend (Node.js)
  # ----------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hms_backend
    restart: unless-stopped
    ports:
      - "4000:4000"
    env_file:
      - .env
    environment:
      - PORT=4000
      - MONGO_URI=mongodb://mongodb:27017/healthcare_db
      # AI Service URL (internal docker network)
      - AI_SERVICE_URL=http://ai-service:8000
      - NODE_ENV=production
    volumes:
      - uploads_data:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
      ai-service:
        condition: service_started
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:4000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - hms_network

  # ----------------------------
  # AI Service (Python)
  # ----------------------------
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    container_name: hms_ai_service
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Backend URL (internal docker network)
      - BACKEND_URL=http://backend:4000/api
    volumes:
      - uploads_data:/app/uploads
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - hms_network

  # ----------------------------
  # Frontend (React + Nginx)
  # ----------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: hms_frontend
    restart: unless-stopped
    ports:
      - "5173:80" # Mapping host 5173 to container 80 (Nginx)
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - hms_network

volumes:
  mongo_data:
    driver: local
  uploads_data:
    driver: local

networks:
  hms_network:
    driver: bridge
